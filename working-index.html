<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Chat Application</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-comments"></i>
                <h1>ChatApp</h1>
                <p>Connect with friends in real-time</p>
            </div>
            <div class="login-form">
                <input type="text" id="username-input" placeholder="Enter your username" maxlength="20" value="nirdeshjain">
                <button id="join-btn" type="button">Join Chat</button>
            </div>
            <div class="login-footer">
                <p>Choose a unique username to get started</p>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-screen" class="screen">
        <div class="chat-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2><i class="fas fa-comments"></i> ChatApp</h2>
                    <div class="user-info">
                        <i class="fas fa-user"></i>
                        <span id="current-user">Guest</span>
                    </div>
                </div>
                
                <div class="room-section">
                    <div class="section-header">
                        <h3>Chat Rooms</h3>
                        <button id="create-room-btn" class="create-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="room-list" class="room-list">
                        <div class="room-item active" data-room="general">
                            <div class="room-content">
                                <div class="room-name">General</div>
                                <div class="room-users">1 users</div>
                            </div>
                        </div>
                        <div class="room-item" data-room="tech">
                            <div class="room-content">
                                <div class="room-name">Tech Talk</div>
                                <div class="room-users">0 users</div>
                            </div>
                            <button class="room-delete-btn" data-room="tech" title="Delete room">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="room-item" data-room="random">
                            <div class="room-content">
                                <div class="room-name">Random</div>
                                <div class="room-users">0 users</div>
                            </div>
                            <button class="room-delete-btn" data-room="random" title="Delete room">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="online-users">
                    <h3>Online Users</h3>
                    <div id="user-list" class="user-list">
                        <div class="user-item current-user">
                            <div class="user-status"></div>
                            <span id="sidebar-username">Guest</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <button id="logout-btn" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="main-chat">
                <div class="chat-header">
                    <div class="room-info">
                        <h2 id="current-room">General</h2>
                        <span id="room-users-count">1 users</span>
                    </div>
                    <div class="chat-actions">
                        <button id="toggle-emoji" class="action-btn">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button id="toggle-formatting" class="action-btn">
                            <i class="fas fa-bold"></i>
                        </button>
                    </div>
                </div>

                <div class="messages-container">
                    <div id="messages" class="messages">
                        <div class="message">
                            <div class="message-header">
                                <span class="message-author">System</span>
                                <span class="message-time">Just now</span>
                            </div>
                            <div class="message-content">Welcome to the chat! Start typing to send messages.</div>
                        </div>
                    </div>
                </div>

                <!-- Emoji Picker -->
                <div id="emoji-picker" class="emoji-picker" style="display: none;">
                    <div class="emoji-grid">
                        <span class="emoji-item">😀</span>
                        <span class="emoji-item">😂</span>
                        <span class="emoji-item">😍</span>
                        <span class="emoji-item">🤔</span>
                        <span class="emoji-item">😊</span>
                        <span class="emoji-item">😎</span>
                        <span class="emoji-item">🤝</span>
                        <span class="emoji-item">👍</span>
                        <span class="emoji-item">👎</span>
                        <span class="emoji-item">❤️</span>
                        <span class="emoji-item">🎉</span>
                        <span class="emoji-item">🔥</span>
                        <span class="emoji-item">💯</span>
                        <span class="emoji-item">✨</span>
                        <span class="emoji-item">🚀</span>
                        <span class="emoji-item">⭐</span>
                        <span class="emoji-item">💡</span>
                        <span class="emoji-item">🎯</span>
                        <span class="emoji-item">📱</span>
                        <span class="emoji-item">💻</span>
                        <span class="emoji-item">🖥️</span>
                        <span class="emoji-item">⚡</span>
                        <span class="emoji-item">🌟</span>
                        <span class="emoji-item">🎊</span>
                    </div>
                </div>

                <!-- Formatting Toolbar -->
                <div id="formatting-toolbar" class="formatting-toolbar" style="display: none;">
                    <button class="format-btn" data-format="bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="format-btn" data-format="italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="format-btn" data-format="underline">
                        <i class="fas fa-underline"></i>
                    </button>
                    <button class="format-btn" data-format="code">
                        <i class="fas fa-code"></i>
                    </button>
                </div>

                <div class="message-input-container">
                    <div class="input-area">
                        <input type="text" id="message-input" placeholder="Type your message..." maxlength="500">
                        <button id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <script>
        console.log('Script starting...');
        
        // Simple notification function
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Simple login function
        function handleLogin() {
            console.log('handleLogin called');
            
            const usernameInput = document.getElementById('username-input');
            const loginScreen = document.getElementById('login-screen');
            const chatScreen = document.getElementById('chat-screen');
            const currentUser = document.getElementById('current-user');
            const sidebarUsername = document.getElementById('sidebar-username');
            
            if (!usernameInput || !loginScreen || !chatScreen) {
                console.error('Required elements not found');
                alert('Error: Required elements not found');
                return;
            }
            
            const username = usernameInput.value.trim();
            console.log('Username:', username);
            
            if (!username) {
                showNotification('Please enter a username', 'error');
                return;
            }
            
            if (username.length < 3) {
                showNotification('Username must be at least 3 characters long', 'error');
                return;
            }
            
            console.log('Switching screens...');
            
            // Hide login screen
            loginScreen.classList.remove('active');
            loginScreen.style.display = 'none';
            
            // Show chat screen
            chatScreen.classList.add('active');
            chatScreen.style.display = 'block';
            
            // Update username displays
            if (currentUser) currentUser.textContent = username;
            if (sidebarUsername) sidebarUsername.textContent = username;
            
            // Load the default room (General)
            loadRoomMessages('general');
            
            showNotification(`Welcome ${username}!`, 'success');
            
            console.log('Screen switch completed');
        }
        
        // Simple logout function
        function handleLogout() {
            console.log('handleLogout called');
            
            const loginScreen = document.getElementById('login-screen');
            const chatScreen = document.getElementById('chat-screen');
            const usernameInput = document.getElementById('username-input');
            
            if (loginScreen && chatScreen) {
                chatScreen.classList.remove('active');
                chatScreen.style.display = 'none';
                
                loginScreen.classList.add('active');
                loginScreen.style.display = 'flex';
                
                if (usernameInput) usernameInput.value = '';
            }
        }
        
        // Room data storage
        const roomMessages = {
            general: [
                {
                    author: 'System',
                    content: 'Welcome to the General chat room! This is for general discussions.',
                    time: 'Just now'
                }
            ],
            tech: [
                {
                    author: 'System',
                    content: 'Welcome to Tech Talk! Discuss technology and programming here.',
                    time: 'Just now'
                }
            ],
            random: [
                {
                    author: 'System',
                    content: 'Welcome to Random! Share anything and everything here.',
                    time: 'Just now'
                }
            ]
        };
        
        let currentRoom = 'general';
        
        // Function to switch rooms
        function switchRoom(roomName) {
            console.log('Switching to room:', roomName);
            
            currentRoom = roomName;
            
            // Update active room in sidebar
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.room === roomName) {
                    item.classList.add('active');
                }
            });
            
            // Update room header
            const roomHeader = document.getElementById('current-room');
            const roomNames = {
                general: 'General',
                tech: 'Tech Talk',
                random: 'Random'
            };
            
            if (roomHeader) {
                roomHeader.textContent = roomNames[roomName] || roomName;
            }
            
            // Load room messages
            loadRoomMessages(roomName);
        }
        
        // Function to load messages for a room
        function loadRoomMessages(roomName) {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';
            
            const messages = roomMessages[roomName] || [];
            
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${msg.author}</span>
                        <span class="message-time">${msg.time}</span>
                    </div>
                    <div class="message-content">${parseFormattedText(msg.content)}</div>
                `;
                messagesContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Function to delete a room
        function deleteRoom(roomId) {
            console.log('Deleting room:', roomId);
            
            // Prevent deletion of the general room
            if (roomId === 'general') {
                showNotification('Cannot delete the General room', 'error');
                return;
            }
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete this room? All messages will be lost.`)) {
                return;
            }
            
            // Remove room from data
            delete roomMessages[roomId];
            
            // Remove room from sidebar
            const roomElement = document.querySelector(`.room-item[data-room="${roomId}"]`);
            if (roomElement) {
                roomElement.remove();
            }
            
            // If we're currently in the deleted room, switch to General
            if (currentRoom === roomId) {
                switchRoom('general');
            }
            
            showNotification('Room deleted successfully', 'success');
        }

        // Function to create new room (updated to include delete button)
        function createNewRoom() {
            const roomName = prompt('Enter room name:');
            if (!roomName || roomName.trim().length < 3) {
                showNotification('Room name must be at least 3 characters long', 'error');
                return;
            }
            
            const roomId = roomName.toLowerCase().replace(/\s+/g, '-');
            
            // Check if room already exists
            if (roomMessages[roomId]) {
                showNotification('Room already exists', 'error');
                return;
            }
            
            // Create new room
            roomMessages[roomId] = [
                {
                    author: 'System',
                    content: `Welcome to ${roomName}! This room was just created.`,
                    time: 'Just now'
                }
            ];
            
            // Add room to sidebar
            const roomList = document.getElementById('room-list');
            if (roomList) {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-item';
                roomElement.dataset.room = roomId;
                roomElement.innerHTML = `
                    <div class="room-content">
                        <div class="room-name">${roomName}</div>
                        <div class="room-users">1 users</div>
                    </div>
                    <button class="room-delete-btn" data-room="${roomId}" title="Delete room">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                // Add click event for room switching
                const roomContent = roomElement.querySelector('.room-content');
                roomContent.addEventListener('click', () => switchRoom(roomId));
                
                // Add click event for delete button
                const deleteBtn = roomElement.querySelector('.room-delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent room switching when clicking delete
                    deleteRoom(roomId);
                });
                
                roomList.appendChild(roomElement);
            }
            
            showNotification(`Room "${roomName}" created successfully!`, 'success');
            
            // Switch to the new room
            switchRoom(roomId);
        }
        
        // Simple message sending
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messagesContainer = document.getElementById('messages');
            const currentUser = document.getElementById('current-user');
            
            if (!messageInput || !messagesContainer) return;
            
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            const username = currentUser ? currentUser.textContent : 'User';
            const now = new Date().toLocaleTimeString();
            
            // Add message to current room
            if (!roomMessages[currentRoom]) {
                roomMessages[currentRoom] = [];
            }
            
            const newMessage = {
                author: username,
                content: messageText,
                time: now
            };
            
            roomMessages[currentRoom].push(newMessage);
            
            // Display the message
            const messageElement = document.createElement('div');
            messageElement.className = 'message own';
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-author">${username}</span>
                    <span class="message-time">${now}</span>
                </div>
                <div class="message-content">${parseFormattedText(messageText)}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messageInput.value = '';
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Emoji picker functionality
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            const toggleBtn = document.getElementById('toggle-emoji');
            
            if (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') {
                emojiPicker.style.display = 'block';
                toggleBtn.classList.add('active');
                // Hide formatting toolbar if open
                const formattingToolbar = document.getElementById('formatting-toolbar');
                formattingToolbar.style.display = 'none';
                document.getElementById('toggle-formatting').classList.remove('active');
            } else {
                emojiPicker.style.display = 'none';
                toggleBtn.classList.remove('active');
            }
        }

        // Formatting toolbar functionality
        function toggleFormattingToolbar() {
            const formattingToolbar = document.getElementById('formatting-toolbar');
            const toggleBtn = document.getElementById('toggle-formatting');
            
            if (formattingToolbar.style.display === 'none' || formattingToolbar.style.display === '') {
                formattingToolbar.style.display = 'flex';
                toggleBtn.classList.add('active');
                // Hide emoji picker if open
                const emojiPicker = document.getElementById('emoji-picker');
                emojiPicker.style.display = 'none';
                document.getElementById('toggle-emoji').classList.remove('active');
            } else {
                formattingToolbar.style.display = 'none';
                toggleBtn.classList.remove('active');
            }
        }

        // Insert emoji into message input
        function insertEmoji(emoji) {
            const messageInput = document.getElementById('message-input');
            const cursorPos = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPos);
            const textAfter = messageInput.value.substring(messageInput.selectionEnd);
            
            messageInput.value = textBefore + emoji + textAfter;
            messageInput.focus();
            
            // Set cursor position after inserted emoji
            const newPos = cursorPos + emoji.length;
            messageInput.setSelectionRange(newPos, newPos);
            
            // Hide emoji picker after selection
            document.getElementById('emoji-picker').style.display = 'none';
            document.getElementById('toggle-emoji').classList.remove('active');
        }

        // Apply text formatting
        function applyFormatting(format) {
            const messageInput = document.getElementById('message-input');
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            const selectedText = messageInput.value.substring(start, end);
            
            if (selectedText.length === 0) {
                // No text selected, show helper message
                showNotification('Please select text to format', 'info');
                return;
            }
            
            let formattedText = selectedText;
            
            switch (format) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'underline':
                    formattedText = `__${selectedText}__`;
                    break;
                case 'code':
                    formattedText = `\`${selectedText}\``;
                    break;
            }
            
            const textBefore = messageInput.value.substring(0, start);
            const textAfter = messageInput.value.substring(end);
            
            messageInput.value = textBefore + formattedText + textAfter;
            messageInput.focus();
            
            // Set cursor position after formatted text
            const newPos = start + formattedText.length;
            messageInput.setSelectionRange(newPos, newPos);
            
            showNotification(`Applied ${format} formatting`, 'success');
        }
        
        // Function to parse and render formatted text
        function parseFormattedText(text) {
            return text
                // Bold: **text** or __text__
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<u>$1</u>')
                // Italic: *text*
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code: `text`
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Line breaks
                .replace(/\n/g, '<br>');
        }
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Bind login button
            const joinBtn = document.getElementById('join-btn');
            if (joinBtn) {
                console.log('Join button found, binding events');
                joinBtn.addEventListener('click', handleLogin);
                joinBtn.onclick = handleLogin; // Backup
            } else {
                console.error('Join button not found!');
            }
            
            // Bind logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // Bind room switching and delete buttons
            document.querySelectorAll('.room-item').forEach(item => {
                const roomName = item.dataset.room;
                if (roomName) {
                    // Bind room switching - check if room has room-content structure
                    const roomContent = item.querySelector('.room-content');
                    if (roomContent) {
                        // New structure with delete buttons
                        roomContent.addEventListener('click', function() {
                            switchRoom(roomName);
                        });
                    } else {
                        // Old structure (General room)
                        item.addEventListener('click', function() {
                            switchRoom(roomName);
                        });
                    }
                    
                    // Bind delete button if it exists
                    const deleteBtn = item.querySelector('.room-delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation(); // Prevent room switching when clicking delete
                            deleteRoom(roomName);
                        });
                    }
                }
            });
            
            // Bind create room button
            const createRoomBtn = document.getElementById('create-room-btn');
            if (createRoomBtn) {
                createRoomBtn.addEventListener('click', createNewRoom);
            }
            
            // Bind message input
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            // Bind emoji toggle button
            const emojiToggleBtn = document.getElementById('toggle-emoji');
            if (emojiToggleBtn) {
                emojiToggleBtn.addEventListener('click', toggleEmojiPicker);
            }
            
            // Bind formatting toggle button
            const formattingToggleBtn = document.getElementById('toggle-formatting');
            if (formattingToggleBtn) {
                formattingToggleBtn.addEventListener('click', toggleFormattingToolbar);
            }
            
            // Bind emoji picker items
            document.querySelectorAll('.emoji-item').forEach(emojiItem => {
                emojiItem.addEventListener('click', function() {
                    insertEmoji(this.textContent);
                });
            });
            
            // Bind formatting buttons
            document.querySelectorAll('.format-btn').forEach(formatBtn => {
                formatBtn.addEventListener('click', function() {
                    const format = this.dataset.format;
                    applyFormatting(format);
                });
            });
            
            // Close emoji picker and formatting toolbar when clicking outside
            document.addEventListener('click', function(e) {
                const emojiPicker = document.getElementById('emoji-picker');
                const emojiToggle = document.getElementById('toggle-emoji');
                const formattingToolbar = document.getElementById('formatting-toolbar');
                const formattingToggle = document.getElementById('toggle-formatting');
                
                // Close emoji picker if clicking outside
                if (!emojiPicker.contains(e.target) && !emojiToggle.contains(e.target)) {
                    emojiPicker.style.display = 'none';
                    emojiToggle.classList.remove('active');
                }
                
                // Close formatting toolbar if clicking outside
                if (!formattingToolbar.contains(e.target) && !formattingToggle.contains(e.target)) {
                    formattingToolbar.style.display = 'none';
                    formattingToggle.classList.remove('active');
                }
            });

            // Bind username input enter key
            const usernameInput = document.getElementById('username-input');
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
            
            console.log('All event listeners bound');
        });
        
        // Test function for debugging
        window.testLogin = function() {
            console.log('Test login function called');
            handleLogin();
        };
    </script>
</body>
</html>
